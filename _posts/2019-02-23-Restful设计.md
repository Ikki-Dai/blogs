# Restful设计

## 实践中的困惑

- 接口名称：通常会设计一个接口叫  `/add` 或者是 `/insert`, 后台对应数据的插入操作，但是从来没有互相约束为 一定叫add 还是叫insert
- 不幂等的设计：有时候会对某个开关设计一个叫 `/toggle` 或者  `/switch`, 调用一次会将这个状态置为相反的状态，在网络出现问题时，会出现和预期不一致的状态
- 杂乱的状态码设计：**我们永远无法预料到程序里所有可能出现的错误，但是我们总是能知道我们期望的正确结果**

## Restful 的设计哲学

Restful[^Rest] 是由 Roy Thomas Fielding[^Thomas] 在2000 年的博士论文中提出的。

- 一切皆资源   这令人想到 Linux 的设计哲学：一切皆文件

- 每个资源由唯一URL标识

- 资源处理使用 POST, GET, PUT, DELETE方法对应 创建，读取, 更新，删除操作，此处对应数据库的CURD操作

- 幂等性 一个请求执行一次和执行N次的结果是一致的

- 状态码 使用Http Status


## 处理一些蛋疼的例子

- 前提：restful 是一种设计风格，并不是明确的规范

### 一切皆资源

- 系统通常有一个用户登录，我们设计为 `/login`,  但是设计为 `POST /sessions ` 就略显别扭，虽然这个在逻辑上是说的通的
- 播放音乐的接口，理解为创建一个播放状态，可以变更为 `POST /musics/{id}?status=play` , 修改某个音乐的状态为播放

### 方法动词 

- 当url **严格设计**为**名词**时, 使用 对应的请求方法，则表述性会更强

| 方法   | 操作 | 描述                                                  |
| ------ | ---- | ----------------------------------------------------- |
| GET    | 获取 | 查询，比如 GET /cars/231, 获取编号为231的车子信息     |
| POST   | 新建 | POST 请求是不幂等的，因为我们允许有多辆属性相同的车子 |
| PUT    | 更新 | 修改， 比如 PUT /cars/231, 修改标号为231 的车辆信息   |
| DELETE | 删除 | 比如 DELETE /cars/231, 删除编号231 的车辆信息         |

- 多条件查询时, 使用GET方法只能在URL 后面缀上长串的 Key=Value ，显得啰嗦且难于记忆，这时，我们可以创建一个 `POST /cars/queries` 的URL ，表示创建一个查询; 如果设计成异步，可以在该接口返回202 状态码，并在body 里响应一个地址如: `https://domain.com/cars/queries/31421`,

- 使用一级URL 更有助于记忆和理解，但这不是绝对的

### 使用正确的状态码

- 比如404,　表示接口找不到呢还是资源接口不存在？　我的理解是，restful接口的实现者，就算没有很好的实践 `HATEOAS`  ,但是至少会提供接口文档，所以不会存在调用了一个不存在的接口的情况

- 状态码会不会不够用？绝大部分情况下，一个接口总是返回一个甚至２个期望的结果，但是出现异常的情况却有很多，所以与其期望明确定义好每一种异常情况，不如做好异常业务状态的提示信息的用户体验

  | 状态码 | 说明       |
  | ------ | ---------- |
  | 1xx    | 消息       |
  | 2xx    | 成功       |
  | 3xx    | 重定向     |
  | 4xx    | 错误请求   |
  | 5xx    | 服务器错误 |

## 总结

- 如果你不熟悉Restful, 还是多在各种业务场景下练习抽象思维
- 如果某个业务场景不适合使用Restful, 可以试试变通的抽象
- 跟详细的定义http 定义可以 阅读 [rfc7231](https://www.rfc-editor.org/rfc/rfc7231.html), 其中详细描述了各请求状态码的含义


----
[^Rest]:(Resource) Representational State Transfer, 资源表征状态转移

[^Thomas]: Roy Thomas Fielding 是HTTP 协议的主要设计者、Apache服务器的作者之一、Apache基金会的第一任主席。
